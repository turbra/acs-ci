stages:
  - build
  - push
  - scan
 
Build the image:
  stage: build
  script:
    - docker build --tag="escape:1.0" .
  only:
    - shell-scan

Push image:
  stage: push
  script:
    - docker login -u $USER -p $TOKEN docker.io
    - docker tag escape:1.0 repo.example.com/namespace/escape:1.0
    - docker push repo.example.com/namespace/escape:1.0
  tags:
    - runner-shell
  only:
    - shell-scan
  allow_failure: true

Scan the image:
  stage: scan
  script:
    - 'curl -k -H "Authorization: Bearer $ROX_API_TOKEN" "$STACKROX_CENTRAL_HOST":443/api/cli/download/roxctl-linux -o roxctl && chmod +x ./roxctl'
    - ./roxctl --insecure-skip-tls-verify -e $STACKROX_CENTRAL_HOST:443 image check --image=repo.example.com/namespace/escape:1.0
  tags:
    - runner-shell
  only:
    - shell-scan
  allow_failure: true
