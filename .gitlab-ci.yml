stages:
  - build
  - push
  - scan
 
Build the image:
  stage: build
  script:
    - "docker build -t escape:1.0 ."
  tags:
    - runner-shell
  only:
    - container-scan

Push image:
  stage: push
  script:
    - docker login -u $USER -p $TOKEN docker.io
    - docker tag escape:1.0 repo.example.com/namespace/escape:1.0
    - docker push repo.example.com/namespace/escape:1.0

  tags:
    - runner-shell
  only:
    - container-scan
  allow_failure: true

Scan the image:
  image:
    name: registry.access.redhat.com/advanced-cluster-security/rhacs-roxctl-rhel8:3.74.1-1
    entrypoint: ["/bin/sh", "-c"] # override image entrypoint as default is /usr/bin/roxctl
  stage: scan
  script:
    - ROX_API_TOKEN=$ROX_API_TOKEN
    - STACKROX_CENTRAL_HOST=$STACKROX_CENTRAL_HOST
    - roxctl --insecure-skip-tls-verify image check -e $STACKROX_CENTRAL_HOST:443 --image=repo.example.com/namespace/escape:1.0
  tags:
    - docker-runner
  only:
    - container-scan
  allow_failure: true
